<div class="modal modal-blur fade" id="modal-new-program" tabindex="-1" style="display: none; padding-left: 0px;"
    aria-modal="true" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Program</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="mb-3">
                    <label class="form-label">Program Image</label>
                    <div id="programImageBox" class="border rounded d-flex align-items-center justify-content-center"
                        style="height: 150px; cursor: pointer;">
                        <span id="programImagePlus" style="font-size: 2rem; color: #6c757d;">+</span>
                    </div>
                    <input type="file" id="programImageInput" name="programImage" accept="image/*"
                        style="display: none;">
                </div>

                <div class="mb-3">
                    <label class="form-label">Program Title</label>
                    <input type="text" name="title" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Gender</label>
                    <select name="gender" class="form-select" required>
                        <option value="">Select</option>
                        <option value="boys">Boys</option>
                        <option value="girls">Girls</option>
                        <option value="both">Both</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="programDescription" name="description" class="form-control" rows="10"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Special Features</label>
                    <textarea id="specialFeatures" name="specialFeatures" class="form-control" rows="10"></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Age Range</label>
                        <input type="text" name="ageRange" class="form-control" placeholder="6 to 10">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Duration</label>
                        <input type="text" name="duration" class="form-control" placeholder="5 days / 4 nights">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <div class="form-selectgroup-boxes row mb-3 program-status">
                        <div class="col-lg-6">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="status" value="active" class="form-selectgroup-input" checked=""/>
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span class="form-selectgroup-label-content">
                                        <span class="form-selectgroup-title strong mb-1">Active</span>
                                        <span class="d-block text-secondary">Program is active.</span>
                                    </span>
                                </span>
                            </label>
                        </div>
                        <div class="col-lg-6">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="status" value="in-active" class="form-selectgroup-input"/>
                                <span class="form-selectgroup-label d-flex align-items-center p-3">
                                    <span class="me-3">
                                        <span class="form-selectgroup-check"></span>
                                    </span>
                                    <span class="form-selectgroup-label-content">
                                        <span class="form-selectgroup-title strong mb-1">In active</span>
                                        <span class="d-block text-secondary">Program is in- active.</span>
                                    </span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">
                    Cancel
                </a>
                <a href="#" class="btn btn-primary ms-auto" onclick="saveNewProgram(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 5l0 14"></path>
                        <path d="M5 12l14 0"></path>
                    </svg>
                    Create Program
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    
    let programEditor, featuresEditor;

    ClassicEditor
        .create(document.querySelector('#programDescription'))
        .then(editor => {
            programEditor = editor;
        })
        .catch(error => {
            console.error(error);
        });

    ClassicEditor
        .create(document.querySelector('#specialFeatures'))
        .then(editor => {
            featuresEditor = editor;
        })
        .catch(error => {
            console.error(error);
        });



    $("#programImageBox").on("click", function () {
        $("#programImageInput").click();
    });

    let previousImageUrl = null;

    $("#programImageInput").on("change", function () {
        var file = this.files[0];
        if (!file) return;

        if (previousImageUrl) {
            $.ajax({
                url: "/delete-program-image",
                type: "POST",
                data: { imageUrl: previousImageUrl },
                success: function (res) {
                    console.log("Previous image deleted");
                },
                error: function (err) {
                    console.log("Failed to delete previous image");
                }
            });
        }

        var formData = new FormData();
        formData.append("programImage", file);

        $.ajax({
            url: "/upload-program-image",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            beforeSend: function () {
                $("#programImageBox").html('<span style="font-size:1rem; color:#6c757d;">Uploading...</span>');
            },
            success: function (res) {
                $("#programImageBox").html('<img src="' + res.imageUrl + '" style="height:100%; width:100%; object-fit:cover; border-radius:0.25rem;">');
                previousImageUrl = res.imageUrl;
            },
            error: function (err) {
                $("#programImageBox").html('<span style="font-size:2rem; color:#6c757d;">+</span>');
                alert("Image upload failed. Try again.");
            }
        });
    });

    const saveNewProgram = (btn) => {
        const modal = $(btn).closest('.modal');

        const imageUrl = $("#programImageBox img").attr("src");
        const title = modal.find('input[name="title"]').val().trim();
        const age = modal.find('input[name="ageRange"]').val().trim();
        const duration = modal.find('input[name="duration"]').val().trim();
        const description = programEditor.getData().trim();
        const specialFeatures = featuresEditor.getData().trim();
        const gender = modal.find('select[name="gender"]').val();
        const status = $("input[name='status']:checked").val();

        const data = {
            imageUrl,
            title,
            age,
            duration,
            description,
            specialFeatures,
            gender,
            status,
        };

        $.ajax({
            url: "/programs",
            type: "POST",
            data,
            success: function (res) {
                alert("Program created successfully");
                window.location.href = "/programs";
            },
            error: function (err) {
                console.log(err);
                alert("Failed to create program");
            }
        });
    };
</script>